<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnóstico Empresarial Daton</title>
    <link rel="icon" href="https://daton.com.br/wp-content/uploads/2023/06/cropped-favicon-daton-32x32.png" sizes="32x32" /><br/>
    <link rel="icon" href="https://daton.com.br/wp-content/uploads/2023/06/cropped-favicon-daton-192x192.png" sizes="192x192" /><br/>
    <link rel="apple-touch-icon" href="https://daton.com.br/wp-content/uploads/2023/06/cropped-favicon-daton-180x180.png" /><br/>
    <meta name="msapplication-TileImage" content="https://daton.com.br/wp-content/uploads/2023/06/cropped-favicon-daton-270x270.png" />
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;<br/>
            margin: 0;<br/>
            padding: 0;<br/>
            background-color: #f4f7f6;<br/>
            color: #333;<br/>
            display: flex;<br/>
            flex-direction: column;<br/>
            min-height: 100vh;
        }
        header {
            background-color: #004d40; /* Dark Teal */<br/>
            color: white;<br/>
            padding: 15px 20px;<br/>
            display: flex;<br/>
            justify-content: space-between;<br/>
            align-items: center;<br/>
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);<br/>
            flex-wrap: wrap;
        }
        header h1 {
            margin: 0;<br/>
            font-size: 24px;<br/>
            display: flex;<br/>
            align-items: center;
        }
        header h1 img {
            height: 40px;<br/>
            margin-right: 10px;
        }
        .header-controls {
            display: flex;<br/>
            gap: 10px;<br/>
            align-items: center;<br/>
            flex-wrap: wrap;<br/>
            margin-top: 5px;
        }
        .header-controls button, .header-controls select {
            padding: 8px 15px;<br/>
            border: none;<br/>
            border-radius: 5px;<br/>
            cursor: pointer;<br/>
            font-size: 14px;<br/>
            transition: background-color 0.3s ease;
        }
        .header-controls button.primary {
            background-color: #00796b; /* Medium Teal */<br/>
            color: white;
        }
        .header-controls button.primary:hover {<br/>
            background-color: #00695c; /* Slightly darker Teal */
        }
        .header-controls button.secondary {
            background-color: #e0e0e0;<br/>
            color: #333;
        }
        .header-controls button.secondary:hover {<br/>
            background-color: #d0d0d0;
        }
        .header-controls select {
            background-color: white;<br/>
            border: 1px solid #ccc;
        }
        main {
            display: flex;<br/>
            flex: 1;<br/>
            padding: 20px;<br/>
            gap: 20px;<br/>
            flex-wrap: wrap;
        }
        .sidebar {
            flex: 0 0 280px;<br/>
            background-color: white;<br/>
            padding: 20px;<br/>
            border-radius: 8px;<br/>
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);<br/>
            overflow-y: auto;<br/>
            max-height: calc(100vh - 120px);
        }
        .sidebar h2 {
            margin-top: 0;<br/>
            color: #004d40;<br/>
            font-size: 20px;<br/>
            border-bottom: 1px solid #eee;<br/>
            padding-bottom: 10px;<br/>
            margin-bottom: 15px;
        }
        .sidebar ul {
            list-style: none;<br/>
            padding: 0;
        }
        .sidebar ul li {
            margin-bottom: 10px;
        }
        .sidebar ul li a {
            text-decoration: none;<br/>
            color: #555;<br/>
            display: block;<br/>
            padding: 8px 10px;<br/>
            border-radius: 4px;<br/>
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .sidebar ul li a:hover {<br/>
            background-color: #e0f2f1; /* Light Teal */<br/>
            color: #004d40;
        }
        .sidebar ul li a.active {
            background-color: #00796b;<br/>
            color: white;<br/>
            font-weight: bold;
        }
        .content {
            flex: 1;<br/>
            background-color: white;<br/>
            padding: 25px;<br/>
            border-radius: 8px;<br/>
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);<br/>
            overflow-y: auto;<br/>
            max-height: calc(100vh - 120px);
        }
        .content h2 {
            color: #004d40;<br/>
            margin-top: 0;<br/>
            font-size: 22px;<br/>
            border-bottom: 1px solid #eee;<br/>
            padding-bottom: 10px;<br/>
            margin-bottom: 20px;
        }
        .question-section {
            margin-bottom: 30px;
        }
        .question-section h3 {
            color: #00796b;<br/>
            margin-bottom: 15px;<br/>
            font-size: 18px;
        }
        .question-item {
            background-color: #f9f9f9;<br/>
            border: 1px solid #eee;<br/>
            border-radius: 6px;<br/>
            padding: 15px;<br/>
            margin-bottom: 15px;
        }
        .question-item label {
            display: block;<br/>
            margin-bottom: 10px;<br/>
            font-weight: bold;<br/>
            color: #444;
        }
        .question-item textarea {
            width: calc(100% - 20px);<br/>
            padding: 10px;<br/>
            border: 1px solid #ccc;<br/>
            border-radius: 4px;<br/>
            min-height: 60px;<br/>
            resize: vertical;<br/>
            font-size: 14px;
        }
        .question-item select {
            width: 100%;<br/>
            padding: 10px;<br/>
            border: 1px solid #ccc;<br/>
            border-radius: 4px;<br/>
            font-size: 14px;<br/>
            background-color: white;
        }
        .question-item .score-display {
            margin-top: 10px;<br/>
            font-weight: bold;<br/>
            color: #004d40;
        }
        .question-item .ai-suggestion {
            margin-top: 15px;<br/>
            padding: 10px;<br/>
            background-color: #e0f2f1;<br/>
            border-left: 4px solid #00796b;<br/>
            border-radius: 4px;<br/>
            font-size: 13px;<br/>
            color: #333;
        }
        .question-item .ai-suggestion p {
            margin: 0 0 5px 0;
        }
        .question-item .ai-suggestion strong {
            color: #004d40;
        }
        .question-item .ai-suggestion button {
            background-color: #00796b;<br/>
            color: white;<br/>
            border: none;<br/>
            padding: 5px 10px;<br/>
            border-radius: 4px;<br/>
            cursor: pointer;<br/>
            font-size: 12px;<br/>
            margin-top: 5px;<br/>
            transition: background-color 0.3s ease;
        }
        .question-item .ai-suggestion button:hover {<br/>
            background-color: #00695c;
        }
        .results {
            margin-top: 30px;<br/>
            padding-top: 20px;<br/>
            border-top: 1px solid #eee;
        }
        .results h2 {
            color: #004d40;<br/>
            font-size: 22px;<br/>
            margin-bottom: 20px;
        }
        .results-summary {
            display: flex;<br/>
            flex-wrap: wrap;<br/>
            gap: 20px;<br/>
            margin-bottom: 30px;
        }
        .summary-card {
            background-color: #e0f2f1;<br/>
            border-left: 5px solid #00796b;<br/>
            border-radius: 8px;<br/>
            padding: 20px;<br/>
            flex: 1;<br/>
            min-width: 250px;<br/>
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .summary-card h3 {
            margin-top: 0;<br/>
            color: #004d40;<br/>
            font-size: 18px;<br/>
            margin-bottom: 10px;
        }
        .summary-card p {
            margin: 0;<br/>
            font-size: 16px;<br/>
            color: #333;
        }
        .results-details {
            display: grid;<br/>
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));<br/>
            gap: 20px;
        }
        .detail-card {
            background-color: #f9f9f9;<br/>
            border: 1px solid #eee;<br/>
            border-radius: 8px;<br/>
            padding: 20px;<br/>
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }
        .detail-card h3 {
            margin-top: 0;<br/>
            color: #00796b;<br/>
            font-size: 18px;<br/>
            margin-bottom: 10px;
        }
        .detail-card p {
            font-size: 14px;<br/>
            line-height: 1.6;<br/>
            color: #555;
        }
        .detail-card ul {
            list-style: disc;<br/>
            margin-left: 20px;<br/>
            padding: 0;<br/>
            font-size: 14px;<br/>
            color: #555;
        }
        .detail-card ul li {
            margin-bottom: 5px;
        }
        footer {
            background-color: #004d40;<br/>
            color: white;<br/>
            text-align: center;<br/>
            padding: 15px 20px;<br/>
            margin-top: 20px;<br/>
            font-size: 14px;<br/>
            box-shadow: 0 -2px 4px rgba(0,0,0,0.05);
        }
        .toast {
            visibility: hidden;<br/>
            min-width: 250px;<br/>
            background-color: #333;<br/>
            color: #fff;<br/>
            text-align: center;<br/>
            border-radius: 5px;<br/>
            padding: 16px;<br/>
            position: fixed;<br/>
            z-index: 1;<br/>
            left: 50%;<br/>
            transform: translateX(-50%);<br/>
            bottom: 30px;<br/>
            font-size: 17px;<br/>
            white-space: nowrap;
        }
        .toast.show {
            visibility: visible;<br/>
            -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;<br/>
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }
        @-webkit-keyframes fadein {
            from {bottom: 0; opacity: 0;} <br/>
            to {bottom: 30px; opacity: 1;}
        }
        @keyframes fadein {
            from {bottom: 0; opacity: 0;}<br/>
            to {bottom: 30px; opacity: 1;}
        }
        @-webkit-keyframes fadeout {
            from {bottom: 30px; opacity: 1;} <br/>
            to {bottom: 0; opacity: 0;}
        }
        @keyframes fadeout {
            from {bottom: 30px; opacity: 1;}<br/>
            to {bottom: 0; opacity: 0;}
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            header {
                flex-direction: column;<br/>
                align-items: flex-start;
            }
            .header-controls {
                margin-top: 15px;<br/>
                width: 100%;<br/>
                justify-content: flex-start;
            }
            .header-controls button, .header-controls select {
                flex-grow: 1;
            }
            main {
                flex-direction: column;<br/>
                padding: 15px;
            }
            .sidebar {
                flex: none;<br/>
                width: 100%;<br/>
                max-height: none;
            }
            .content {
                flex: none;<br/>
                width: 100%;<br/>
                max-height: none;<br/>
                padding: 20px;
            }
            .results-summary {
                flex-direction: column;
            }
            .summary-card {
                min-width: unset;<br/>
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>
            <img src="https://daton.com.br/wp-content/uploads/2023/06/cropped-favicon-daton-192x192.png" alt="Daton Logo">
            Diagnóstico Empresarial
        </h1>
        <div class="header-controls">
            <select id="aiModelSelect">
                <option value="gemini">IA: Gemini</option><br/>
                <option value="openai">IA: OpenAI</option>
            </select>
            <button class="secondary" onclick="openConfig()">Configurar IA</button>
            <button class="primary" onclick="generateInsights()">Gerar Insights</button>
            <button class="secondary" onclick="exportToPDF()">Exportar PDF</button>
            <button class="secondary" onclick="resetForm()">Limpar Tudo</button>
        </div>
    </header>

    <main>
        <aside class="sidebar">
            <h2>Áreas de Análise</h2>
            <ul id="section-list">
                <!-- Sections will be loaded here by JavaScript -->
            </ul>
        </aside>

        <section class="content" id="question-content">
            <!-- Questions will be loaded here by JavaScript -->
        </section>
    </main>

    <footer>
        &copy; 2024 Daton. Todos os direitos reservados.
    </footer>

    <div id="toast" class="toast"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script><br/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        // Global state object
        const state = {
            currentSection: 'gestao-estrategica',<br/>
            answers: {},<br/>
            ai: {<br/>
                model: 'gemini', // Default AI model<br/>
                openaiKey: '',<br/>
                geminiKey: '',<br/>
                backendEndpoint: '' // Optional backend endpoint for AI calls
            },
            sections: [
                {
                    id: 'gestao-estrategica',<br/>
                    name: 'Gestão Estratégica',<br/>
                    questions: [<br/>
                        { id: 'q1', text: 'A empresa possui uma missão, visão e valores claramente definidos e comunicados a todos os colaboradores?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q2', text: 'Existe um planejamento estratégico formal (ex: plano de negócios, OKRs) com metas e indicadores de desempenho claros?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q3', text: 'A empresa realiza análise SWOT ou outras ferramentas para identificar forças, fraquezas, oportunidades e ameaças regularmente?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q4', text: 'Os objetivos estratégicos são desdobrados em metas táticas e operacionais para cada área/equipe?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q5', text: 'A liderança da empresa demonstra comprometimento e engajamento com a execução da estratégia?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q6', text: 'Existe um processo de acompanhamento e revisão periódica do planejamento estratégico?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q7', text: 'A cultura organizacional está alinhada com a estratégia e os valores da empresa?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q8', text: 'A empresa possui um plano de sucessão para cargos chave?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q9', text: 'A empresa utiliza indicadores de desempenho (KPIs) para monitorar o progresso em relação aos objetivos estratégicos?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q10', text: 'A empresa promove a inovação e a adaptação a novas tendências de mercado?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q11', text: 'Descreva brevemente a estratégia atual da sua empresa e como ela se diferencia dos concorrentes.', type: 'textarea' },<br/>
                        { id: 'q12', text: 'Quais são os 3 maiores desafios estratégicos que sua empresa enfrenta hoje?', type: 'textarea' }
                    ]
                },
                {
                    id: 'gestao-financeira',<br/>
                    name: 'Gestão Financeira',<br/>
                    questions: [<br/>
                        { id: 'q1', text: 'A empresa possui um orçamento anual detalhado e o acompanha regularmente?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q2', text: 'Existe um fluxo de caixa projetado e real, com análise de entradas e saídas?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q3', text: 'A empresa realiza análise de custos e despesas para identificar oportunidades de otimização?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q4', text: 'Os preços dos produtos/serviços são definidos com base em custos, valor percebido e concorrência?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q5', text: 'A empresa possui capital de giro adequado para suas operações?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q6', text: 'Há um controle rigoroso de contas a pagar e a receber?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q7', text: 'A empresa realiza projeções financeiras para cenários futuros (otimista, realista, pessimista)?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q8', text: 'Existe uma política de gestão de riscos financeiros (ex: câmbio, juros, inadimplência)?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q9', text: 'A empresa utiliza ferramentas de análise financeira (ex: DRE, Balanço Patrimonial) para tomada de decisão?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q10', text: 'A empresa possui acesso a linhas de crédito e financiamento adequadas às suas necessidades?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q11', text: 'Qual a principal fonte de receita da sua empresa e como ela é gerida?', type: 'textarea' },<br/>
                        { id: 'q12', text: 'Quais são os 3 maiores desafios financeiros que sua empresa enfrenta hoje?', type: 'textarea' }
                    ]
                },
                {
                    id: 'gestao-de-marketing-e-vendas',<br/>
                    name: 'Gestão de Marketing e Vendas',<br/>
                    questions: [<br/>
                        { id: 'q1', text: 'A empresa possui um plano de marketing e vendas com objetivos e estratégias claras?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q2', text: 'Existe uma definição clara do público-alvo e das personas dos clientes?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q3', text: 'A empresa utiliza canais de marketing digital (ex: redes sociais, e-mail marketing, SEO)?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q4', text: 'Há um processo de vendas bem definido, desde a prospecção até o pós-venda?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q5', text: 'A equipe de vendas recebe treinamento e acompanhamento contínuo?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q6', text: 'A empresa monitora a satisfação do cliente e utiliza o feedback para melhorias?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q7', text: 'Existe um CRM (Customer Relationship Management) ou sistema similar para gerenciar clientes e vendas?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q8', text: 'A empresa realiza campanhas de marketing e vendas com métricas de desempenho (ROI)?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q9', text: 'A empresa possui uma proposta de valor clara e comunicada de forma eficaz?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q10', text: 'A empresa se adapta às mudanças no comportamento do consumidor e nas tendências de mercado?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q11', text: 'Descreva suas principais estratégias de marketing e vendas e o que as torna eficazes.', type: 'textarea' },<br/>
                        { id: 'q12', text: 'Quais são os 3 maiores desafios de marketing e vendas que sua empresa enfrenta hoje?', type: 'textarea' }
                    ]
                },
                {
                    id: 'gestao-de-pessoas',<br/>
                    name: 'Gestão de Pessoas',<br/>
                    questions: [<br/>
                        { id: 'q1', text: 'A empresa possui um plano de recrutamento e seleção eficaz para atrair talentos?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q2', text: 'Existe um programa de integração (onboarding) para novos colaboradores?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q3', text: 'A empresa investe no desenvolvimento e treinamento contínuo dos colaboradores?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q4', text: 'Há um sistema de avaliação de desempenho justo e transparente?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q5', text: 'A empresa oferece um plano de carreira e oportunidades de crescimento profissional?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q6', text: 'Existe uma política de remuneração e benefícios competitiva e alinhada ao mercado?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q7', text: 'A empresa promove um ambiente de trabalho saudável, com boa comunicação e clima organizacional?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q8', text: 'Há um processo eficaz para gerenciar conflitos e resolver problemas entre colaboradores?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q9', text: 'A empresa reconhece e recompensa o bom desempenho dos colaboradores?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q10', text: 'A empresa possui uma baixa taxa de rotatividade (turnover) de colaboradores?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q11', text: 'Como sua empresa atrai e retém os melhores talentos?', type: 'textarea' },<br/>
                        { id: 'q12', text: 'Quais são os 3 maiores desafios na gestão de pessoas que sua empresa enfrenta hoje?', type: 'textarea' }
                    ]
                },
                {
                    id: 'gestao-de-processos-e-operacoes',<br/>
                    name: 'Gestão de Processos e Operações',<br/>
                    questions: [<br/>
                        { id: 'q1', text: 'Os processos operacionais da empresa são mapeados, documentados e otimizados regularmente?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q2', text: 'A empresa utiliza tecnologia e automação para otimizar processos e reduzir erros?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q3', text: 'Existe um controle de qualidade eficaz para produtos/serviços?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q4', text: 'A empresa gerencia seu estoque de forma eficiente, evitando excessos ou faltas?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q5', text: 'Há um plano de manutenção preventiva para equipamentos e infraestrutura?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q6', text: 'A empresa possui um plano de contingência para interrupções operacionais (ex: desastres, falhas de sistema)?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q7', text: 'Os fornecedores são avaliados e gerenciados para garantir qualidade e pontualidade?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q8', text: 'A empresa utiliza indicadores de desempenho (KPIs) para monitorar a eficiência operacional?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q9', text: 'A empresa busca a melhoria contínua dos seus processos (ex: Lean, Six Sigma)?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q10', text: 'A empresa cumpre as normas e regulamentações de segurança e meio ambiente?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q11', text: 'Descreva o processo operacional mais crítico da sua empresa e como ele é gerenciado.', type: 'textarea' },<br/>
                        { id: 'q12', text: 'Quais são os 3 maiores desafios operacionais que sua empresa enfrenta hoje?', type: 'textarea' }
                    ]
                },
                {
                    id: 'gestao-de-tecnologia-e-inovacao',<br/>
                    name: 'Gestão de Tecnologia e Inovação',<br/>
                    questions: [<br/>
                        { id: 'q1', text: 'A empresa possui uma estratégia de tecnologia alinhada aos objetivos de negócio?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q2', text: 'Existe um plano de investimento em tecnologia e inovação?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q3', text: 'A empresa utiliza sistemas de gestão (ERP, CRM, BI) para otimizar processos e tomada de decisão?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q4', text: 'Há uma política de segurança da informação e proteção de dados (LGPD)?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q5', text: 'A empresa investe em pesquisa e desenvolvimento (P&D) ou em novas tecnologias?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q6', text: 'Os colaboradores recebem treinamento para utilizar as tecnologias disponíveis?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q7', text: 'A empresa monitora as tendências tecnológicas e as aplica em seu negócio?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q8', text: 'Existe um processo para gerenciar projetos de tecnologia e inovação?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q9', text: 'A empresa utiliza a análise de dados (Big Data, Analytics) para obter insights e tomar decisões?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q10', text: 'A empresa possui uma infraestrutura de TI robusta e segura?', type: 'select', options: ['Não se aplica', 'Não', 'Parcialmente', 'Sim'], score: [0, 1, 3, 5] },<br/>
                        { id: 'q11', text: 'Quais tecnologias são mais importantes para o sucesso da sua empresa e como você as utiliza?', type: 'textarea' },<br/>
                        { id: 'q12', text: 'Quais são os 3 maiores desafios de tecnologia e inovação que sua empresa enfrenta hoje?', type: 'textarea' }
                    ]
                }
            ]
        };

        // Load state from localStorage
        function loadState() {
            const savedState = localStorage.getItem('diagnosticoEmpresarialState');
            if (savedState) {
                Object.assign(state, JSON.parse(savedState));
            }
        }

        // Save state to localStorage
        function saveState() {
            localStorage.setItem('diagnosticoEmpresarialState', JSON.stringify(state));
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            loadState();
            renderSidebar();
            loadSection(state.currentSection);
            document.getElementById('aiModelSelect').value = state.ai.model;
        });

        // Render sidebar navigation
        function renderSidebar() {
            const sectionList = document.getElementById('section-list');
            sectionList.innerHTML = '';
            state.sections.forEach(section => {
                const listItem = document.createElement('li');
                const link = document.createElement('a');
                link.href = `#${section.id}`;
                link.textContent = section.name;
                link.onclick = (e) => {
                    e.preventDefault();
                    loadSection(section.id);
                };
                listItem.appendChild(link);
                sectionList.appendChild(listItem);
            });
            updateSidebarActiveLink();
        }

        // Update active link in sidebar
        function updateSidebarActiveLink() {
            const links = document.querySelectorAll('#section-list a');
            links.forEach(link => {
                if (link.getAttribute('href') === `#${state.currentSection}`) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        }

        // Load questions for a specific section
        function loadSection(sectionId) {
            state.currentSection = sectionId;
            saveState();
            updateSidebarActiveLink();

            const questionContent = document.getElementById('question-content');
            questionContent.innerHTML = '';

            const currentSectionData = state.sections.find(s => s.id === sectionId);
            if (!currentSectionData) return;

            const sectionTitle = document.createElement('h2');
            sectionTitle.textContent = currentSectionData.name;
            questionContent.appendChild(sectionTitle);

            currentSectionData.questions.forEach(q => {
                const questionItem = document.createElement('div');
                questionItem.className = 'question-item';
                questionItem.id = `question-${q.id}`;

                const label = document.createElement('label');
                label.htmlFor = `${sectionId}-${q.id}`;
                label.textContent = q.text;
                questionItem.appendChild(label);

                if (q.type === 'select') {
                    const select = document.createElement('select');
                    select.id = `${sectionId}-${q.id}`;
                    q.options.forEach((optionText, index) => {
                        const option = document.createElement('option');
                        option.value = index; // Use index as value to map to score
                        option.textContent = optionText;
                        select.appendChild(option);
                    });
                    select.value = state.answers[sectionId]?.[q.id]?.value !== undefined ? state.answers[sectionId][q.id].value : 0;
                    select.onchange = (e) => {
                        saveAnswer(sectionId, q.id, e.target.value, q.score ? q.score[e.target.value] : 0);
                        updateScoreDisplay(sectionId, q.id);
                    };
                    questionItem.appendChild(select);

                    const scoreDisplay = document.createElement('div');
                    scoreDisplay.className = 'score-display';
                    scoreDisplay.id = `score-${sectionId}-${q.id}`;
                    questionItem.appendChild(scoreDisplay);
                    updateScoreDisplay(sectionId, q.id);

                    const aiSuggestion = document.createElement('div');
                    aiSuggestion.className = 'ai-suggestion';
                    aiSuggestion.id = `ai-suggestion-${sectionId}-${q.id}`;
                    aiSuggestion.style.display = 'none'; // Hidden by default
                    questionItem.appendChild(aiSuggestion);

                    const suggestButton = document.createElement('button');
                    suggestButton.textContent = 'Sugerir Nota (IA)';
                    suggestButton.onclick = () => suggestScore(sectionId, q.id);
                    questionItem.appendChild(suggestButton);

                } else if (q.type === 'textarea') {
                    const textarea = document.createElement('textarea');
                    textarea.id = `${sectionId}-${q.id}`;
                    textarea.placeholder = 'Digite sua resposta aqui...';
                    textarea.value = state.answers[sectionId]?.[q.id]?.text || '';
                    textarea.oninput = (e) => saveAnswer(sectionId, q.id, e.target.value);
                    questionItem.appendChild(textarea);

                    const aiSuggestion = document.createElement('div');
                    aiSuggestion.className = 'ai-suggestion';
                    aiSuggestion.id = `ai-suggestion-${sectionId}-${q.id}`;
                    aiSuggestion.style.display = 'none'; // Hidden by default
                    questionItem.appendChild(aiSuggestion);

                    const generateButton = document.createElement('button');
                    generateButton.textContent = 'Gerar Resposta (IA)';
                    generateButton.onclick = () => generateTextAnswer(sectionId, q.id);
                    questionItem.appendChild(generateButton);
                }

                questionContent.appendChild(questionItem);
            });
        }

        // Save answer to state
        function saveAnswer(sectionId, questionId, value, score = null) {
            if (!state.answers[sectionId]) {
                state.answers[sectionId] = {};
            }
            if (score !== null) {
                state.answers[sectionId][questionId] = { value: value, score: score };
            } else {
                state.answers[sectionId][questionId] = { text: value };
            }
            saveState();
        }

        // Update score display for select questions
        function updateScoreDisplay(sectionId, questionId) {
            const scoreDisplay = document.getElementById(`score-${sectionId}-${questionId}`);
            if (scoreDisplay) {
                const answer = state.answers[sectionId]?.[questionId];
                if (answer && answer.score !== undefined) {
                    scoreDisplay.textContent = `Pontuação: ${answer.score}`;
                } else {
                    scoreDisplay.textContent = 'Pontuação: 0';
                }
            }
        }

        // Calculate total score for a section
        function getSectionScore(sectionId) {
            const sectionData = state.sections.find(s => s.id === sectionId);
            if (!sectionData) return { total: 0, max: 0 };

            let totalScore = 0;
            let maxScore = 0;

            sectionData.questions.forEach(q => {
                if (q.type === 'select' && q.score) {
                    maxScore += Math.max(...q.score); // Max possible score for this question
                    const answer = state.answers[sectionId]?.[q.id];
                    if (answer && answer.score !== undefined) {
                        totalScore += answer.score;
                    }
                }
            });
            return { total: totalScore, max: maxScore };
        }

        // Display toast messages
        function toast(message) {
            const toastElement = document.getElementById('toast');
            toastElement.textContent = message;
            toastElement.classList.add('show');
            setTimeout(() => {
                toastElement.classList.remove('show');
            }, 3000);
        }

        // AI Integration
        async function callOpenAI(prompt) {
            if (!state.ai.openaiKey) {
                throw new Error('OpenAI API Key não configurada. Clique em "Configurar IA" primeiro.');
            }
            const url = 'https://api.openai.com/v1/chat/completions';
            const response = await fetch(url, {
                method: 'POST',<br/>
                headers: {<br/>
                    'Content-Type': 'application/json',<br/>
                    'Authorization': `Bearer ${state.ai.openaiKey}`
                },
                body: JSON.stringify({<br/>
                    model: 'gpt-3.5-turbo',<br/>
                    messages: [{ role: 'user', content: prompt }],<br/>
                    temperature: 0.7,<br/>
                    max_tokens: 500
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`OpenAI error ${response.status}: ${errorData.error.message}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        async function callGemini (prompt){
            const apiKey = state.ai.geminiKey;
            if (!apiKey) {
                throw new Error('Gemini key não configurada. Clique em "Configurar IA" primeiro.');
            }
            
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
            
            const res = await fetch(url, {
                method: "POST", <br/>
                headers: { "Content-Type": "application/json" },<br/>
                body: JSON.stringify({ <br/>
                    contents: [{role:"user", parts: [{text:prompt}]}], <br/>
                    generationConfig: {temperature:0.3} 
                })
            });
            
            if(!res.ok) throw new Error("Gemini error "+res.status);
            const data = await res.json();
            return data.candidates?.[0]?.content?.parts?.map(p=>p.text||"").join("") || "";
        }

        async function callAI(prompt) {
            if (state.ai.backendEndpoint) {
                // Use backend for AI calls if configured
                const response = await fetch(state.ai.backendEndpoint, {
                    method: 'POST',<br/>
                    headers: { 'Content-Type': 'application/json' },<br/>
                    body: JSON.stringify({ model: state.ai.model, prompt: prompt, apiKey: state.ai.model === 'openai' ? state.ai.openaiKey : state.ai.geminiKey })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Backend AI error ${response.status}: ${errorData.message}`);
                }
                const data = await response.json();
                return data.response;
            } else {
                // Use direct API calls
                if (state.ai.model === 'gemini') {
                    return callGemini(prompt);
                } else if (state.ai.model === 'openai') {
                    return callOpenAI(prompt);
                }
            }
            throw new Error('Nenhum modelo de IA selecionado ou configurado.');
        }

        async function suggestScore(sectionId, questionId) {
            const questionData = state.sections.find(s => s.id === sectionId).questions.find(q => q.id === questionId);
            const aiSuggestionDiv = document.getElementById(`ai-suggestion-${sectionId}-${questionId}`);
            const selectElement = document.getElementById(`${sectionId}-${questionId}`);

            aiSuggestionDiv.innerHTML = '<p><strong>IA:</strong> Gerando sugestão...</p>';
            aiSuggestionDiv.style.display = 'block';

            try {
                const prompt = `A pergunta é: "${questionData.text}". As opções de resposta são: ${questionData.options.join(', ')}. As pontuações correspondentes são: ${questionData.score.join(', ')}. Baseado na pergunta, qual seria a pontuação mais adequada (0, 1, 3 ou 5)? Responda apenas com o número da pontuação.`;
                const aiResponse = await callAI(prompt);
                const suggestedScore = parseInt(aiResponse.trim());

                if (!isNaN(suggestedScore) && questionData.score.includes(suggestedScore)) {
                    const optionIndex = questionData.score.indexOf(suggestedScore);
                    selectElement.value = optionIndex;
                    saveAnswer(sectionId, questionId, optionIndex, suggestedScore);
                    updateScoreDisplay(sectionId, questionId);
                    aiSuggestionDiv.innerHTML = `<p><strong>IA Sugere:</strong> ${questionData.options[optionIndex]} (Pontuação: ${suggestedScore})</p><button onclick="applySuggestion('${sectionId}', '${questionId}', ${optionIndex}, ${suggestedScore})">Aplicar</button>`;
                } else {
                    aiSuggestionDiv.innerHTML = `<p><strong>IA:</strong> Não foi possível gerar uma sugestão válida. Resposta da IA: "${aiResponse}"</p>`;
                }
            } catch (error) {
                console.error('Erro ao sugerir nota com IA:', error);<br/>
                aiSuggestionDiv.innerHTML = `<p style="color: red;"><strong>Erro ao sugerir:</strong> ${error.message}</p>`;
            }
        }

        function applySuggestion(sectionId, questionId, value, score) {
            const selectElement = document.getElementById(`${sectionId}-${questionId}`);
            selectElement.value = value;
            saveAnswer(sectionId, questionId, value, score);
            updateScoreDisplay(sectionId, questionId);
            document.getElementById(`ai-suggestion-${sectionId}-${questionId}`).style.display = 'none';
            toast('Sugestão da IA aplicada!');
        }

        async function generateTextAnswer(sectionId, questionId) {
            const questionData = state.sections.find(s => s.id === sectionId).questions.find(q => q.id === questionId);
            const aiSuggestionDiv = document.getElementById(`ai-suggestion-${sectionId}-${questionId}`);
            const textareaElement = document.getElementById(`${sectionId}-${questionId}`);

            aiSuggestionDiv.innerHTML = '<p><strong>IA:</strong> Gerando resposta...</p>';
            aiSuggestionDiv.style.display = 'block';

            try {
                const prompt = `A pergunta é: "${questionData.text}". Gere uma resposta concisa e relevante para esta pergunta, como se fosse a resposta de uma empresa.`;
                const aiResponse = await callAI(prompt);
                
                aiSuggestionDiv.innerHTML = `<p><strong>IA Sugere:</strong> ${aiResponse}</p><button onclick="applyTextSuggestion('${sectionId}', '${questionId}', \`${aiResponse.replace(/`/g, '\`')}\`)">Aplicar</button>`;
            } catch (error) {
                console.error('Erro ao gerar resposta com IA:', error);<br/>
                aiSuggestionDiv.innerHTML = `<p style="color: red;"><strong>Erro ao gerar:</strong> ${error.message}</p>`;
            }
        }

        function applyTextSuggestion(sectionId, questionId, text) {
            const textareaElement = document.getElementById(`${sectionId}-${questionId}`);
            textareaElement.value = text;
            saveAnswer(sectionId, questionId, text);
            document.getElementById(`ai-suggestion-${sectionId}-${questionId}`).style.display = 'none';
            toast('Sugestão da IA aplicada!');
        }

        // Configure AI API Keys
        function openConfig(){
            const openaiKey = prompt("Cole sua OpenAI API Key (vazio mantém atual):", "");
            if(openaiKey !== null && openaiKey.trim()) state.ai.openaiKey = openaiKey.trim();
            const geminiKey = prompt("Cole sua Gemini API Key (vazio mantém atual):", "");
            if(geminiKey !== null && geminiKey.trim()) state.ai.geminiKey = geminiKey.trim();
            const endpoint = prompt("Endpoint backend (recomendado em produção). Vazio = DEV no browser:", state.ai.backendEndpoint || "");
            if(endpoint !== null) state.ai.backendEndpoint = endpoint.trim();
            saveConfig();
            toast("Config IA salva.");
        }

        function saveConfig() {
            localStorage.setItem('diagnosticoEmpresarialState', JSON.stringify(state));
        }

        document.getElementById('aiModelSelect').addEventListener('change', (e) => {
            state.ai.model = e.target.value;
            saveState();
            toast(`Modelo de IA alterado para ${state.ai.model.toUpperCase()}`);
        });

        // Generate overall insights
        async function generateInsights() {
            toast('Gerando insights com IA... Aguarde.');
            const insightsContent = document.createElement('div');
            insightsContent.className = 'results';
            insightsContent.innerHTML = '<h2>Resultados e Insights da IA</h2>';

            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'results-summary';
            insightsContent.appendChild(summaryDiv);

            const opportunitiesDiv = document.createElement('div');
            opportunitiesDiv.className = 'detail-card';
            opportunitiesDiv.innerHTML = '<h3>Oportunidades de Melhoria</h3><p>Gerando...</p>';
            insightsContent.appendChild(opportunitiesDiv);

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'detail-card';
            actionsDiv.innerHTML = '<h3>Ações Recomendadas</h3><p>Gerando...</p>';
            insightsContent.appendChild(actionsDiv);

            const questionContent = document.getElementById('question-content');
            questionContent.innerHTML = ''; // Clear current questions
            questionContent.appendChild(insightsContent);

            try {
                const fullReport = generateFullReportText();
                const promptSummary = `Analise o seguinte diagnóstico empresarial e forneça um resumo conciso da situação geral da empresa, destacando pontos fortes e fracos. Use no máximo 150 palavras. Diagnóstico: ${fullReport}`;<br/>
                const promptOpportunities = `Com base no seguinte diagnóstico empresarial, liste 3 a 5 oportunidades de melhoria específicas e acionáveis para a empresa. Use formato de lista. Diagnóstico: ${fullReport}`;<br/>
                const promptActions = `Com base no seguinte diagnóstico empresarial, liste 3 a 5 ações recomendadas detalhadas para a empresa, com foco em como implementar as melhorias. Use formato de lista. Diagnóstico: ${fullReport}`;

                const [summary, opportunities, actions] = await Promise.all([
                    callAI(promptSummary),
                    callAI(promptOpportunities),
                    callAI(promptActions)
                ]);

                // Overall Score Card
                const totalScore = state.sections.reduce((acc, section) => {
                    const { total } = getSectionScore(section.id);
                    return acc + total;
                }, 0);
                const maxPossibleScore = state.sections.reduce((acc, section) => {
                    const { max } = getSectionScore(section.id);
                    return acc + max;
                }, 0);
                const percentageScore = maxPossibleScore > 0 ? ((totalScore / maxPossibleScore) * 100).toFixed(2) : 0;

                const scoreCard = document.createElement('div');
                scoreCard.className = 'summary-card';
                scoreCard.innerHTML = `<h3>Pontuação Geral</h3><p>Total: ${totalScore} / ${maxPossibleScore}</p><p>Percentual: ${percentageScore}%</p>`;
                summaryDiv.appendChild(scoreCard);

                // Summary Card
                const summaryCard = document.createElement('div');
                summaryCard.className = 'summary-card';
                summaryCard.innerHTML = `<h3>Resumo Geral da IA</h3><p>${summary}</p>`;
                summaryDiv.appendChild(summaryCard);

                opportunitiesDiv.innerHTML = `<h3>Oportunidades de Melhoria</h3>${formatAIResponseAsList(opportunities)}`;
                actionsDiv.innerHTML = `<h3>Ações Recomendadas</h3>${formatAIResponseAsList(actions)}`;

                toast('Insights gerados com sucesso!');

            } catch (error) {
                console.error('Erro ao gerar insights:', error);<br/>
                questionContent.innerHTML = `<h2 style="color: red;">Erro ao Gerar Insights</h2><p style="color: red;">Não foi possível gerar os insights. Verifique sua chave de API e tente novamente. Detalhes do erro: ${error.message}</p>`;
                toast('Erro ao gerar insights!');
            }
        }

        function generateFullReportText() {
            let report = "Diagnóstico Empresarial:\n\n";
            state.sections.forEach(section => {
                report += `## ${section.name}\n`;
                section.questions.forEach(q => {
                    const answer = state.answers[section.id]?.[q.id];
                    if (q.type === 'select') {
                        const selectedOption = answer?.value !== undefined ? q.options[answer.value] : 'Não respondido';<br/>
                        const score = answer?.score !== undefined ? answer.score : 0;<br/>
                        report += ` - ${q.text}: ${selectedOption} (Pontuação: ${score})\n`;
                    } else if (q.type === 'textarea') {
                        const textAnswer = answer?.text || 'Não respondido';
                        report += ` - ${q.text}: ${textAnswer}\n`;
                    }
                });
                report += '\n';
            });
            return report;
        }

        function formatAIResponseAsList(text) {
            // Split by common list delimiters like numbers, hyphens, or newlines
            const items = text.split(/(\d+\.\s*|\*\s*|-\s*)/).filter(item => item.trim() !== '');
            let formattedList = '<ul>';
            let currentItem = '';

            items.forEach(item => {
                const trimmedItem = item.trim();
                if (trimmedItem.match(/^\d+\.$/) || trimmedItem.match(/^\*$/) || trimmedItem.match(/^-$/)) {
                    // It's a list marker, start new item if current one is not empty
                    if (currentItem) {
                        formattedList += `<li>${currentItem.replace(/^-?\s*\d*\.?\s*/, '')}</li>`;
                        currentItem = '';
                    }
                } else {
                    currentItem += trimmedItem + ' ';
                }
            });
            if (currentItem) {
                formattedList += `<li>${currentItem.replace(/^-?\s*\d*\.?\s*/, '')}</li>`;
            }
            formattedList += '</ul>';
            
            // Fallback if simple split doesn't work well (e.g., plain paragraph)
            if (formattedList === '<ul></ul>' && text.trim() !== '') {
                return `<p>${text}</p>`;
            }

            return formattedList;
        }

        // Export to PDF
        async function exportToPDF() {
            toast('Gerando PDF... Aguarde.');
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const content = document.querySelector('.content'); // Select the main content area

            // Temporarily hide buttons and interactive elements for cleaner PDF
            const buttons = content.querySelectorAll('button, select');
            buttons.forEach(btn => btn.style.display = 'none');
            const aiSuggestions = content.querySelectorAll('.ai-suggestion');
            aiSuggestions.forEach(sugg => sugg.style.display = 'none');

            // Use html2canvas to render the content as an image
            html2canvas(content, {
                scale: 2, // Increase scale for better resolution<br/>
                useCORS: true, // Important for images from external sources<br/>
                windowWidth: content.scrollWidth,<br/>
                windowHeight: content.scrollHeight
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210; // A4 width in mm
                const pageHeight = 297; // A4 height in mm
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                doc.save('diagnostico-empresarial.pdf');
                toast('PDF gerado com sucesso!');

                // Restore hidden elements
                buttons.forEach(btn => btn.style.display = '');
                aiSuggestions.forEach(sugg => sugg.style.display = '');

            }).catch(error => {
                console.error('Erro ao gerar PDF:', error);
                toast('Erro ao gerar PDF!');
                // Restore hidden elements even on error
                buttons.forEach(btn => btn.style.display = '');
                aiSuggestions.forEach(sugg => sugg.style.display = '');
            });
        }

        // Reset form
        function resetForm() {
            if (confirm('Tem certeza que deseja limpar todas as respostas e configurações?')) {
                localStorage.removeItem('diagnosticoEmpresarialState');
                state.answers = {};
                state.ai.openaiKey = '';
                state.ai.geminiKey = '';
                state.ai.backendEndpoint = '';
                state.ai.model = 'gemini'; // Reset to default
                document.getElementById('aiModelSelect').value = 'gemini';
                saveState();
                loadSection(state.currentSection); // Reload current section to clear inputs
                toast('Formulário e configurações limpos!');
            }
        }
    </script>
</body>
</html>
